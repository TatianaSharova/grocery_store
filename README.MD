Grocery store - backend API-сервис для магазина продуктов.
Покупатели могут просматривать продукты, их категорию или подкатегория, складывать продукты в корзину, редактировать их количество в корзине или вовсе удалить отдельный продукт или очистить всю корзину сразу. Администраторы могут управлять каталогом товаров, категориями, подкатегориям, пользователями и их корзинами через интерфейс администрирования Django или API.
                
Стек: Python, Django, DRF, PostgreSQL, Pytest, Docker-compose, Gunicorn, Nginx, Prometheus, Grafana, django-admin-interface.                               
                     
___
**Как запустить проект:**

1. Клонировать репозиторий и перейти в него в командной строке:

```
git clone https://github.com/TatianaSharova/grocery_store.git
```
**_Запуск проекта через docker-compose:_**  

2. Используйте .env.example и создайте свой .env в корне проекта.                                              
3. В терминал для запуска выполните команду:

```bash
docker compose up --build  
```
При запуске проекта автоматически создается админ по вашим данным из .env, а также загружаются фикстуры в базу данных.       
4. Админка проекта станет доступна [по ссылке](http://127.0.0.1:8888/admin/)
                                         
**Доступ к API**
-----------
Анонимные пользователи могут просматривать продукты, категории и подкатегории, не могут совершать операции с корзиной.                    
Админы могут совершать CRUD операции с продуктами, категориями, подкатегориям, юзерами и корзиной.                      
Для авторизации используются токены.                                  
                                                                               
Процесс регистрации и авторизации:
1. Отправить POST-запрос с телом {"username": "name", "password": "yourpassword", "email": "email@mail.com"} на эндпоинт:
```
http://127.0.0.1:8000/api/users/
```
2. Отправить POST-запрос с телом {"username": "name", "password": "yourpassword"} на эндпоинт:
```
http://127.0.0.1:8000/api/auth/token/login/
```
Полученный в ответе токен в запросах добавить в Headers = {"Authorization": "Token yourtoken"}

**Использование API**
-----------
1. Просмотр списка товаров или определенного товара по id:

```
GET http://127.0.0.1:8000/api/products/
GET http://127.0.0.1:8000/api/products/id/
```
Предусмотрена пагинация: по 3 товара на странице.                 
2. Просмотр списка продуктовых категорий или определенной категории по id:
```
GET http://127.0.0.1:8000/api/groups/
GET http://127.0.0.1:8000/api/groups/id/
```
Предусмотрена пагинация: по 3 категории на странице.                        
3. Просмотр списка продуктовых подкатегорий или определенной подкатегории по id:
```
GET http://127.0.0.1:8000/api/types/
GET http://127.0.0.1:8000/api/types/id/
```
Предусмотрена пагинация: по 3 подкатегории на странице.                     
4. Добавление продукта в корзину (только для авторизованных пользователей):
```
POST http://127.0.0.1:8000/api/cart/
body example: {"product": "Молоко 2%", "amount": 1}
```
5. Просмотр своей корзины (только для авторизованных пользователей):
```
GET http://127.0.0.1:8000/api/cart/
```
6. Изменение количества продукта в корзине:
```
PATCH http://127.0.0.1:8000/api/cart/update-product/
body example: {"product": "Молоко 2%", "amount": 2}
```
7. Удаление продукта из корзины (только для авторизованных пользователей):
```
PATCH http://127.0.0.1:8000/api/cart/remove-product/
body example: {"product": "Молоко 2%"}
```
8. Очистка всей корзины (только для авторизованных пользователей):
```
DELETE http://127.0.0.1:8000/api/cart/clear-cart/
```
                    
Также админ может совершать CRUD-операции с категориями, подкатегориями, пользователями, товарами.

**Администрирование**
-----------
Админка находится по адресу:
```
http://127.0.0.1:8000/admin/
```
Зайдите в админку, используя созданный вами пароль и имя для админа из .env. В админ-зоне поддерживается весь функционал сервиса: можно создавать, изменять и удалять товары, категории, подкатегории, добавлять товары в корзины пользователей и редактировать их.

Админ-зону можно кастомизировать под себя, выбрав понравившиеся цвета. Настроить можно в модуле Интерфейс администрирования - Темы. Подробнее об этом [по ссылке](https://github.com/fabiocaccamo/django-admin-interface).
                            
**Тестирование**
-----------
Pytest тесты расположены в директории grocery_store/store/products/pytest_tests. Чтобы их запустить из директории grocery_store/store, выполните код:
```
pytest
```

**Мониторинг**
В качестве системы мониторинга к проекту подключен Prometheus, который собирает и хранит метрики, и Grafana, визуализирующая эти метрики. Чтобы защитить передаваемые данные, необходимо подключить TLS-сертификат к Prometheus и Grafana.       
      
Для подключения TLS к Prometheus необхожимо создать сертификаты и добавить их в контейнер store_prometheus. Настройки для создания ключей находятся в файле monitoring/ssl_certs/openssl.cnf.      
Шаги для подключения TLS к Prometheus:    

1. Переходим в папку monitoring/ssl_certs:
```
cd monitoring/ssl_certs
```
2. Генерируем приватный ключ для подписи сертификатов, выданных вашим центром сертификации (CA):
```
openssl genrsa -out ca.key 2048
```
3. Создаем самоподписанный сертификат для центра сертификации (CA):
```
openssl req -new -x509 -days 365 -key ca.key -out ca.crt -config openssl.cnf
```
4. Генерируем новый приватный ключ и запрос на сертификат CSR (Certificate Signing Request):
```
openssl req -newkey rsa:2048 -nodes -keyout server.key -config openssl.cnf -out server.csr
```
5. Создаем подписанный сертификат на основе CSR:
```
openssl x509 -req -extfile openssl.cnf -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -sha256 -extensions req_ext
```
6. Необходимо поместить полученные файлы server.crt и server.key внутрь контейнера store_prometheus в директорию /prometheus/certs/. Перед этим необходимо добавить в .env CERTS_PATH='/c/user/.../grocery_store/monitoring/ssl_certs' cо значением полного пути до директории ssl_certs на вашем локальном компьютере (или выполнить в терминале: export CERTS_PATH='/c/user/.../grocery_store/monitoring/ssl_certs').    
Далее в отдельном терминале выполните скрипт:
```
chmod +x copy_certs.sh

bash copy_certs.sh
```
7. Перезапустите контейнер store_prometheus:
```
docker restart store_prometheus
```
8. Вы можете проверить, содержит ли ваш сертификат SAN (Subject Alternative Name), для этого в директории с созданными ключами выполните:
```
openssl x509 -in server.crt -text -noout
```
         
После запуска проекта Prometheus доступен по ссылке: https://localhost:9090/prometheus
Grafana доступна по ссылке: http://localhost:3000/

Dashboard id для postgresql: 9628            
Dashboard id для NGINX: 12708 17452        
Dashboard id для Django: 9528 7996 17658
                            
**Документация:**                                      
Документацию к API после запуска проекта можно посмотреть по адресам:
```
http://127.0.0.1:8000/schema/redoc/
```
```
http://127.0.0.1:8000/schema/swagger-ui/
```

### Автор
[Татьяна Шарова](https://github.com/TatianaSharova)
